// Add this function to your existing Apps Script
function doGet(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'sync') {
      // Handle sync from dashboard
      const updatesParam = e.parameter.updates;
      if (updatesParam) {
        const updates = JSON.parse(updatesParam);
        return handleSync(updates);
      }
      return createResponse({ success: false, message: 'No updates provided' });
    }
    
    // Default: return questions
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return createResponse([]);
    }
    
    const headers = data[0];
    const questions = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const question = {};
      
      for (let j = 0; j < headers.length; j++) {
        const headerName = headers[j];
        let value = row[j];
        
        if (value === '' || value === null || value === undefined) {
          if (headerName === 'Status') value = 'New';
          if (headerName === 'ID') value = 'Q' + (i + 1000);
          if (headerName === 'Name') value = 'Anonymous';
          if (headerName === 'Tanzeem') value = 'Not Specified';
          if (headerName === 'Question') value = '[No question provided]';
        }
        
        question[headerName] = value;
      }
      
      if (!question.ID || question.ID === '') {
        question.ID = 'Q' + (i + 1000);
      }
      
      if (!question.Status || question.Status === '') {
        question.Status = 'New';
      }
      
      questions.push(question);
    }
    
    console.log('Returning ' + questions.length + ' questions');
    return createResponse(questions);
    
  } catch (error) {
    console.error('Error in doGet: ' + error.toString());
    return createResponse({ error: error.toString() });
  }
}

function handleSync(updates) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const idCol = headers.indexOf('ID');
    const statusCol = headers.indexOf('Status');
    
    if (idCol === -1 || statusCol === -1) {
      return createResponse({ success: false, message: 'ID or Status column not found' });
    }
    
    let updatedCount = 0;
    
    for (const update of updates) {
      for (let i = 1; i < data.length; i++) {
        if (data[i][idCol] == update.id) {
          sheet.getRange(i + 1, statusCol + 1).setValue(update.newStatus);
          updatedCount++;
          break;
        }
      }
    }
    
    return HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Sync Complete</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; text-align: center; }
            .success { color: green; font-size: 24px; margin: 20px 0; }
            .info { color: #666; margin: 20px 0; }
          </style>
        </head>
        <body>
          <div class="success">âœ“ Sync Successful!</div>
          <div class="info">Updated ${updatedCount} questions in Google Sheets.</div>
          <div class="info">You can close this tab now.</div>
        </body>
      </html>
    `);
    
  } catch (error) {
    console.error('Sync error:', error);
    return createResponse({ success: false, message: error.toString() });
  }
}

function createResponse(data) {
  const output = ContentService.createTextOutput(JSON.stringify(data));
  output.setMimeType(ContentService.MimeType.JSON);
  output.setHeaders({
    'Access-Control-Allow-Origin': '*'
  });
  return output;
}
